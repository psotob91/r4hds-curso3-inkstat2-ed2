{
  "hash": "2e5c4fa4fc7dc65dc918016c1e3c620c",
  "result": {
    "markdown": "---\ntitle: \"Taller: Descripción de variables de tiempo\"\nauthor: \"Percy Soto Becerra\"\n---\n\n\n## Introducción\n\nVamos a resolver una serie de ejercicios acerca de gráfocps de variables categóricas. Usaremos un conjunto de datos juguetes acerca de casos de pacientes con Ébola que se atendieron en hospitales de África. Estos datos están disponibles en el libro [The Epidemiologist Handbook](https://epirhandbook.com/en/index.html).\n\n## Cargar paquetes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)      # Paquete con paquetes de funciones diverssa: {dplyr}, {ggplot2}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ ggplot2 3.3.6     ✔ purrr   0.3.4\n✔ tibble  3.1.8     ✔ dplyr   1.0.9\n✔ tidyr   1.2.0     ✔ stringr 1.4.0\n✔ readr   2.1.2     ✔ forcats 0.5.1\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\n```\n:::\n\n```{.r .cell-code}\nlibrary(rio)            # Navaja suiza de la importacion de datos en R\nlibrary(skimr)          # Exploración de datos\nlibrary(summarytools)   # Para generar estadísticos descriptivos\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'summarytools'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:tibble':\n\n    view\n```\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)      # Paquete para manipular fechas usando estilo R tidy\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'lubridate'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    date, intersect, setdiff, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(survival)       # Paquete principal para análisis de datos tiempo-evento\nlibrary(ggsurvfit)      # Paquete para análisis de datos tiempo-evento usando tidy style (ggplot2)\nlibrary(survminer)      # Paquete para analisi de datos tiempo-evento usando tidy style\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: ggpubr\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'survminer'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:survival':\n\n    myeloma\n```\n:::\n:::\n\n\n\n## Importar datos\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_data_small <- import(\"ebola_data_small.rds\")\n```\n:::\n\n\n\n## Análisis Inicial de Datos\n\n- Ver 6 primeras filas:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(ebola_data_small)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 4\n  case_id date_onset date_outcome outcome\n  <chr>   <chr>      <chr>        <chr>  \n1 5fe599  2014-05-13 <NA>         <NA>   \n2 8689b7  2014-05-13 2014-05-18   Recover\n3 11f8ea  2014-05-16 2014-05-30   Recover\n4 b8812a  2014-05-18 <NA>         <NA>   \n5 893f25  2014-05-21 2014-05-29   Recover\n6 be99c8  2014-05-22 2014-05-24   Recover\n```\n:::\n:::\n\n\n- Vistazo a datos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_data_small %>% \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 5,888\nColumns: 4\n$ case_id      <chr> \"5fe599\", \"8689b7\", \"11f8ea\", \"b8812a\", \"893f25\", \"be99c8…\n$ date_onset   <chr> \"2014-05-13\", \"2014-05-13\", \"2014-05-16\", \"2014-05-18\", \"…\n$ date_outcome <chr> NA, \"2014-05-18\", \"2014-05-30\", NA, \"2014-05-29\", \"2014-0…\n$ outcome      <chr> NA, \"Recover\", \"Recover\", NA, \"Recover\", \"Recover\", \"Reco…\n```\n:::\n:::\n\n\n- Un poco má de detalles:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_data_small %>% \n  skim()\n```\n\n::: {.cell-output-display}\nTable: Data summary\n\n|                         |           |\n|:------------------------|:----------|\n|Name                     |Piped data |\n|Number of rows           |5888       |\n|Number of columns        |4          |\n|_______________________  |           |\n|Column type frequency:   |           |\n|character                |4          |\n|________________________ |           |\n|Group variables          |None       |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|case_id       |         0|          1.00|   6|   6|     0|     5888|          0|\n|date_onset    |       256|          0.96|  10|  10|     0|      367|          0|\n|date_outcome  |       936|          0.84|  10|  10|     0|      371|          0|\n|outcome       |      1323|          0.78|   5|   7|     0|        2|          0|\n:::\n:::\n\n\n- Veamos los datos categoricos: \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ebola_data_small %>% \n#   freq()\n```\n:::\n\n\n- Veamos los datos numéricos: \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ebola_data_small %>% \n#   descr()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(ebola_data_small$outcome, useNA = \"always\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  Death Recover    <NA> \n   2582    1983    1323 \n```\n:::\n:::\n\n\n## Crear los datos de tiempo a evento y el indicador del evento\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_data_small %>% \n  mutate(\n    # Convertir a fechas:\n    date_onset = ymd(date_onset), \n    date_outcome = ymd(date_outcome), \n    # Crear la variable tiempo a evento (notar que hay valores negativos implausibles)\n    tseg = as.double(date_outcome - date_onset), \n    # Convertir valores negativos a datos perdidos\n    tseg = case_when(\n      tseg <= 0 ~ as.numeric(NA), \n      tseg > 0 ~ tseg,\n      TRUE ~ as.numeric(NA)\n    ), \n    # Crear la variable indicadora de muerte / censura (1 vs 0)\n    muerte = case_when(\n      outcome == \"Recover\" ~ 0, \n      outcome == \"Death\" ~ 1,\n      TRUE ~ as.numeric(NA)\n    )\n  ) -> ebola_data_small2\n```\n:::\n\n\n- Verificando creación de variable muerte: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(ebola_data_small2$muerte, useNA = \"always\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n   0    1 <NA> \n1983 2582 1323 \n```\n:::\n:::\n\n\n- **Nota:** Si la fecha esta en otros formatos, solo se permuta la y, m y d:\n\n\"13-02-2021\" --> dmy(\"13-02-2021\")\n\n\"02-13-2021\" --> mdy(\"02-13-2021\")\n\n## Calcular tasa/ densidad de incidencia\n\n- Dado que tenemos datos individuales, podemos calcular la densidad de incidencia de muerte:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_data_small2 %>% \n  summarise(densidad_incidencia = 100 * sum(muerte, na.rm = TRUE) / sum(tseg, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 1\n  densidad_incidencia\n                <dbl>\n1                4.75\n```\n:::\n:::\n\nLa densidad de incidencia de muerte en pacientes con ébola fue de 4.84 muertes por 100 días-persona.\n\n## Configurar objeto survival para cálculo de incidencia/supervivencia acumulada\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Surv(tseg, muerte) ~  1\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida <- survfit(Surv(tseg, muerte) ~  1, data = ebola_data_small2)\n```\n:::\n\n\n## Imprimir tabla de vida\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall: survfit(formula = Surv(tseg, muerte) ~ 1, data = ebola_data_small2)\n\n   2389 observations deleted due to missingness \n        n events median 0.95LCL 0.95UCL\n[1,] 3499   1952     12      12      13\n```\n:::\n:::\n\n\n### R base con summary()\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(tabla_vida)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall: survfit(formula = Surv(tseg, muerte) ~ 1, data = ebola_data_small2)\n\n2389 observations deleted due to missingness \n time n.risk n.event survival std.err lower 95% CI upper 95% CI\n    1   3499      30    0.991 0.00156        0.988        0.994\n    2   3464      69    0.972 0.00281        0.966        0.977\n    3   3385     149    0.929 0.00435        0.920        0.937\n    4   3216     194    0.873 0.00565        0.862        0.884\n    5   2989     214    0.810 0.00667        0.797        0.824\n    6   2747     210    0.748 0.00740        0.734        0.763\n    7   2470     179    0.694 0.00790        0.679        0.710\n    8   2232     167    0.642 0.00827        0.626        0.659\n    9   1992     145    0.595 0.00853        0.579        0.612\n   10   1772     109    0.559 0.00870        0.542        0.576\n   11   1592     119    0.517 0.00885        0.500        0.535\n   12   1398      89    0.484 0.00895        0.467        0.502\n   13   1214      55    0.462 0.00902        0.445        0.480\n   14   1097      43    0.444 0.00908        0.427        0.462\n   15    989      31    0.430 0.00913        0.413        0.448\n   16    895      48    0.407 0.00923        0.389        0.426\n   17    775      29    0.392 0.00931        0.374        0.411\n   18    698      21    0.380 0.00938        0.362        0.399\n   19    616       7    0.376 0.00941        0.358        0.395\n   20    554       4    0.373 0.00944        0.355        0.392\n   21    497      13    0.363 0.00957        0.345        0.383\n   22    427       8    0.357 0.00969        0.338        0.376\n   23    378       5    0.352 0.00979        0.333        0.372\n   24    346       4    0.348 0.00989        0.329        0.368\n   25    305       4    0.343 0.01002        0.324        0.363\n   26    274       3    0.339 0.01014        0.320        0.360\n   27    242       1    0.338 0.01019        0.319        0.359\n   29    190       1    0.336 0.01029        0.317        0.357\n   38     60       1    0.331 0.01155        0.309        0.354\n```\n:::\n:::\n\n\n### R tidy con survfit2(), tidy_survfit() de {ggsurvfit}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida2 <- survfit2(Surv(tseg, muerte) ~  1, data = ebola_data_small2)\n```\n:::\n\n\n- Tabla de vida con estimados de supervivencia acumulada:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_survfit(tabla_vida2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 59 × 14\n    time n.risk n.event n.censor cum.e…¹ cum.c…² estim…³ std.e…⁴ conf.…⁵ conf.…⁶\n   <dbl>  <dbl>   <dbl>    <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>\n 1     0   3499       0        0       0       0   1     0         1       1    \n 2     1   3499      30        5      30       5   0.991 0.00157   0.994   0.988\n 3     2   3464      69       10      99      15   0.972 0.00289   0.977   0.966\n 4     3   3385     149       20     248      35   0.929 0.00468   0.937   0.920\n 5     4   3216     194       33     442      68   0.873 0.00647   0.884   0.862\n 6     5   2989     214       28     656      96   0.810 0.00823   0.824   0.797\n 7     6   2747     210       67     866     163   0.748 0.00989   0.763   0.734\n 8     7   2470     179       59    1045     222   0.694 0.0114    0.710   0.679\n 9     8   2232     167       73    1212     295   0.642 0.0129    0.659   0.626\n10     9   1992     145       75    1357     370   0.595 0.0143    0.612   0.579\n# … with 49 more rows, 4 more variables: estimate_type <chr>,\n#   estimate_type_label <chr>, monotonicity_type <chr>, conf.level <dbl>, and\n#   abbreviated variable names ¹​cum.event, ²​cum.censor, ³​estimate, ⁴​std.error,\n#   ⁵​conf.high, ⁶​conf.low\n# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names\n```\n:::\n:::\n\n\n- Tabla de vida con estimados de incidencia acumulada:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_survfit(tabla_vida2, type = \"risk\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 59 × 14\n    time n.risk n.event n.censor cum.e…¹ cum.c…² estim…³ std.e…⁴ conf.…⁵ conf.…⁶\n   <dbl>  <dbl>   <dbl>    <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>\n 1     0   3499       0        0       0       0 0       0       0        0     \n 2     1   3499      30        5      30       5 0.00857 0.00157 0.00551  0.0116\n 3     2   3464      69       10      99      15 0.0283  0.00289 0.0228   0.0338\n 4     3   3385     149       20     248      35 0.0711  0.00468 0.0625   0.0796\n 5     4   3216     194       33     442      68 0.127   0.00647 0.116    0.138 \n 6     5   2989     214       28     656      96 0.190   0.00823 0.176    0.203 \n 7     6   2747     210       67     866     163 0.252   0.00989 0.237    0.266 \n 8     7   2470     179       59    1045     222 0.306   0.0114  0.290    0.321 \n 9     8   2232     167       73    1212     295 0.358   0.0129  0.341    0.374 \n10     9   1992     145       75    1357     370 0.405   0.0143  0.388    0.421 \n# … with 49 more rows, 4 more variables: estimate_type <chr>,\n#   estimate_type_label <chr>, monotonicity_type <chr>, conf.level <dbl>, and\n#   abbreviated variable names ¹​cum.event, ²​cum.censor, ³​estimate, ⁴​std.error,\n#   ⁵​conf.high, ⁶​conf.low\n# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names\n```\n:::\n:::\n\n\n- Solo extraer tiempo, n.event, n.risk y estimado de IA\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_survfit(tabla_vida2, type = \"risk\") %>% \n  select(time, n.event, n.risk, estimate)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 59 × 4\n    time n.event n.risk estimate\n   <dbl>   <dbl>  <dbl>    <dbl>\n 1     0       0   3499  0      \n 2     1      30   3499  0.00857\n 3     2      69   3464  0.0283 \n 4     3     149   3385  0.0711 \n 5     4     194   3216  0.127  \n 6     5     214   2989  0.190  \n 7     6     210   2747  0.252  \n 8     7     179   2470  0.306  \n 9     8     167   2232  0.358  \n10     9     145   1992  0.405  \n# … with 49 more rows\n# ℹ Use `print(n = ...)` to see more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_survfit(tabla_vida2, type = \"risk\") -> tabla_de_vida_resultado\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_de_vida_resultado %>% \n  select(time, n.event, n.risk, estimate) %>% \n  mutate(estimate = estimate * 1000)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 59 × 4\n    time n.event n.risk estimate\n   <dbl>   <dbl>  <dbl>    <dbl>\n 1     0       0   3499     0   \n 2     1      30   3499     8.57\n 3     2      69   3464    28.3 \n 4     3     149   3385    71.1 \n 5     4     194   3216   127.  \n 6     5     214   2989   190.  \n 7     6     210   2747   252.  \n 8     7     179   2470   306.  \n 9     8     167   2232   358.  \n10     9     145   1992   405.  \n# … with 49 more rows\n# ℹ Use `print(n = ...)` to see more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(tabla_vida) -> tabla_de_vida_resultado_rbase\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Esta salida me generaria error porque tabla_de_vida_resultado_rbase no es ni un data.frame ni un data.tibble\n# tabla_de_vida_resultado_rbase %>% \n#   select(time, n.event, n.risk, survival)\n```\n:::\n\n\n## Crear curva de supervivencia mediante método de Kaplan-Meier\n\n### R base con plot() de {survival}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(tabla_vida)\n```\n\n::: {.cell-output-display}\n![](var_tiempo_solucionario_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n### R tidy con ggsurvfit() de {ggsurvfit}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida2 %>% \n  ggsurvfit()\n```\n\n::: {.cell-output-display}\n![](var_tiempo_solucionario_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n### Extra: R tidy con ggsurvplot() de {survminer}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida %>% \n  ggsurvplot()\n```\n\n::: {.cell-output-display}\n![](var_tiempo_solucionario_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n## Personalizar curvas de supervivencia de {ggsurvfit}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_vida2 %>% \n  ggsurvfit(color = \"skyblue\", size = 1) +            # Creas el grafico y configuras color y tamaño de linea\n  add_risktable(theme = theme_risktable_boxed()) +    # Agregas tablas de riesgo y configuras tema de tabla\n  add_censor_mark(color = \"skyblue\") +                # Agregas marcas de censuras y configuras color\n  theme_minimal() +                                   # Configuras tema general del gráfico\n  labs(                                               # Configuras etiquetas del gráfico\n    y = \"Tiempo de seguimiento (días)\", \n    x = \"Supervivencia Acumualda (%)\"\n  )\n```\n\n::: {.cell-output-display}\n![](var_tiempo_solucionario_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "var_tiempo_solucionario_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}